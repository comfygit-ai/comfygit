{"id":"cg-55e","title":"status command makes unnecessary API calls for legacy manager check","description":"The CLI status command calls _show_legacy_manager_notice() which calls env.get_manager_status(). This method fetches latest_version from the live registry API (~1.2s), but the status command only uses the is_legacy field (a local symlink check). Fix: either inline the symlink check in _show_legacy_manager_notice(), or add a lightweight is_legacy_manager() method that skips the API call.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-29T18:09:21.456171199-05:00","created_by":"ubuntu","updated_at":"2025-12-30T03:05:57.904680601-05:00","comments":[{"id":3,"issue_id":"cg-55e","author":"ubuntu","text":"Test comment to verify bd sync is working properly - can be deleted","created_at":"2025-12-30T21:34:25Z"},{"id":5,"issue_id":"cg-55e","author":"ubuntu","text":"Testing bd sync after gitignore fix","created_at":"2025-12-30T23:45:10Z"}]}
{"id":"cg-pnm","title":"Design agent-based QA testing system","description":"## Problem Statement\n\nComfyGit has complex multi-step user flows that unit/integration tests don't fully capture:\n- Workspaces with multiple environments\n- Collaborator sync via push/pull\n- Import/export workflows\n- Workflow resolution with node conflicts\n- Model resolution across sources\n\nManual testing doesn't scale. Users report bugs involving complex command sequences that are hard to replicate in traditional pytest fixtures.\n\n## Proposed Solution\n\nAgent-based QA testing in reproducible containers:\n1. **Nix/Docker images** with deterministic starting state\n2. **Claude Haiku/Sonnet agents** executing test scenarios via CLI\n3. **Structured reports** documenting findings and UX issues\n4. **Parallel execution** (5+ agents) for cost efficiency\n5. **Future: UI testing** inside ComfyUI container\n\n## Key Design Decisions\n\n### Agents for Discovery, Pytest for Regression\n- Agents explore and find bugs (non-deterministic)\n- Once found, convert to deterministic integration tests\n- Don't use agents as CI gates (too slow/expensive)\n\n### Scenario-Based Execution\nDefine scenarios in YAML that agents execute:\n```yaml\nname: Collaborator sync with conflicting node versions\nsteps:\n  - setup: create_workspace --name test-collab\n  - action: node add comfyui-manager==1.0.0\n  - action: git push origin main\n  - setup: simulate_collaborator_push\n  - action: git pull\n  - assert: should_detect_conflict\n```\n\n### Cost Model\n- Haiku: ~$0.25/M input, ~$1.25/M output\n- Target: ~$1-5 per comprehensive test run\n- Run weekly or on-demand, not every commit\n\n## Proposed Directory Structure\n\n```\nqa/\n├── Dockerfile              # Base image: comfygit, claude, uv, git\n├── nix/\n│   └── qa-env.nix          # Optional stricter reproducibility\n├── scenarios/\n│   ├── workflow_sync.yaml\n│   ├── node_conflict.yaml\n│   └── model_resolution.yaml\n├── agent_instructions/\n│   ├── base_system.md      # Core agent behavior\n│   ├── scenario_runner.md  # How to execute scenarios\n│   └── report_format.md    # Required output structure\n├── reports/\n│   └── {timestamp}_{scenario}_{agent_id}.md\n├── scripts/\n│   ├── run_qa.py           # Orchestrate agent containers\n│   ├── parse_reports.py    # Aggregate findings\n│   └── generate_tests.py   # Convert findings to pytest\n└── README.md\n```\n\n## Existing Infrastructure to Build On\n\n- `dev/docker-compose.yml` - Existing Docker setup with GPU support\n- `dev/scripts/cross-platform-test.py` - Parallel test orchestration pattern\n- `packages/core/tests/conftest.py` - 500+ lines of fixtures\n- `packages/core/tests/helpers/` - Fluent test builders (WorkflowBuilder, etc.)\n\n## Implementation Phases\n\n### Phase 1: Proof of Concept\n- [ ] Single scenario, single agent, manual triggering\n- [ ] Basic Dockerfile extending existing dev setup\n- [ ] Simple report format (markdown)\n- [ ] Validate: does agent find real bugs?\n\n### Phase 2: Structure\n- [ ] Scenario YAML DSL design\n- [ ] Structured report format (JSON + markdown)\n- [ ] Agent instruction engineering\n- [ ] Orchestration script\n\n### Phase 3: Scale\n- [ ] Parallel agent execution\n- [ ] Report aggregation and analysis\n- [ ] Integration test generation from findings\n- [ ] Weekly automated runs\n\n## Open Questions\n\n1. Should scenarios be purely declarative or allow agent exploration?\n2. How much ComfyUI setup is needed in containers?\n3. Should we use Nix from the start or defer?\n4. How to handle agent-found bugs that can't be reproduced?\n\n## References\n\n- Discussion context: Agent-based QA testing strategy\n- Existing test stats: ~17K lines integration tests, 90+ tests in core\n- Cross-platform support: Linux, Windows, macOS via SSH","status":"in_progress","priority":2,"issue_type":"epic","created_at":"2025-12-30T02:39:42.649127688-05:00","created_by":"ubuntu","updated_at":"2025-12-30T03:05:57.904312406-05:00","comments":[{"id":1,"issue_id":"cg-pnm","author":"ubuntu","text":"Restructured as epic with 3 phase tasks. Phase 1 PoC complete - validates the approach works. Branch: feature/agent-qa-system","created_at":"2025-12-30T08:02:19Z"},{"id":2,"issue_id":"cg-pnm","author":"ubuntu","text":"Session: Docker-in-Docker + Auth Sharing Setup\n\nAdded portable docker-compose.yml with environment variable configuration:\n- CLAUDE_AUTH_PATH: Path to Claude credentials\n- COMFYGIT_PATH: Path to comfygit repo (HOST path for DinD)\n- Works on both direct host and Docker-in-Docker (ACFS) setups\n\nClaude Auth Sharing for DinD:\n- Added claude-auth named volume to ACFS docker-compose.yml\n- Added entrypoint.sh logic to symlink .credentials.json to shared volume\n- QA container copies credentials on startup to writable /root/.claude/\n- OAuth tokens refresh in ACFS, child containers inherit automatically\n\nNew files:\n- qa/docker-compose.yml - Portable container config\n- qa/.env.example - Configuration template\n- qa/CLAUDE.md - Setup and usage instructions for agents\n\nUpdated:\n- /data/ai-tools/acfs-setup/docker-compose.yml - claude-auth volume\n- /data/ai-tools/acfs-setup/entrypoint.sh - Auth symlink setup\n- qa/Dockerfile - Removed BuildKit cache mounts for compatibility\n- qa/.gitignore - Added .env and placeholder entries\n\nVolume created: acfs-setup_claude-auth (seeded with current credentials)\n\nTested: Claude CLI works in QA container with inherited OAuth auth.","created_at":"2025-12-30T21:27:35Z"},{"id":6,"issue_id":"cg-pnm","author":"ubuntu","text":"Infrastructure: Switch to non-root 'qa' user\n\nChanged the QA container to run as a dedicated 'qa' user instead of root, following the ACFS 'ubuntu' user pattern:\n\n**Dockerfile changes:**\n- Added sudo package\n- Created 'qa' user (uid 1000) with passwordless sudo\n- All directories owned by qa user\n- Switched to USER qa at end of build\n\n**docker-compose.yml changes:**\n- Entrypoint runs as root briefly to copy Claude credentials\n- Credentials copied to /home/qa/.claude/ with correct ownership\n- Drops to qa user via `su - qa` for runtime\n\n**Documentation updates:**\n- Updated all exec commands to use `-u qa` flag\n- Added note about non-root user in CLAUDE.md and docker-compose comments\n\nTested: User verification, Claude auth, writable directories, scenario validation all working.","created_at":"2025-12-30T23:46:00Z"}]}
{"id":"cg-pnm.1","title":"Phase 1: PoC - single agent, manual triggering","description":"Single scenario, single agent, manual triggering. Basic Dockerfile, simple report format. Validate that agent can find real bugs.\n\nDeliverables:\n- qa/Dockerfile with ComfyGit + Claude CLI\n- qa/agent_instructions/ with base system prompt\n- qa/scenarios/ with initial test scenarios\n- qa/scripts/run_scenario.py orchestration script\n- Dry-run and native modes for testing without API","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T03:01:32.365620116-05:00","created_by":"ubuntu","updated_at":"2025-12-30T03:05:57.903921113-05:00","closed_at":"2025-12-30T03:02:11.174705316-05:00","close_reason":"Implemented in f63c435 on feature/agent-qa-system branch","dependencies":[{"issue_id":"cg-pnm.1","depends_on_id":"cg-pnm","type":"parent-child","created_at":"2025-12-30T03:01:32.367791857-05:00","created_by":"daemon"}]}
{"id":"cg-pnm.2","title":"Phase 2: Structured scenarios and reports","description":"Refine the scenario YAML DSL, add structured JSON+markdown report format, improve agent instruction engineering, enhance orchestration script.\n\nDeliverables:\n- Scenario YAML DSL with validation\n- Structured report format (JSON + markdown)\n- Refined agent instructions based on Phase 1 learnings\n- Better error handling in orchestration","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T03:01:43.15770262-05:00","created_by":"ubuntu","updated_at":"2025-12-30T03:22:00.617884367-05:00","closed_at":"2025-12-30T03:22:00.617884367-05:00","close_reason":"Phase 2 complete: schema validation, structured reports, refined instructions","dependencies":[{"issue_id":"cg-pnm.2","depends_on_id":"cg-pnm","type":"parent-child","created_at":"2025-12-30T03:01:43.159787925-05:00","created_by":"daemon"},{"issue_id":"cg-pnm.2","depends_on_id":"cg-pnm.1","type":"blocks","created_at":"2025-12-30T03:02:02.184187529-05:00","created_by":"daemon"}]}
{"id":"cg-pnm.3","title":"Phase 3: Scale - parallel execution and automation","description":"Scale to multiple parallel agents, aggregate reports, generate regression tests from findings, set up weekly automated runs.\n\nDeliverables:\n- Parallel agent execution (5+ agents)\n- Report aggregation and analysis script\n- Integration test generation from agent findings\n- Weekly automated run configuration (cron/CI)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T03:01:53.300004094-05:00","created_by":"ubuntu","updated_at":"2025-12-30T03:05:57.903110471-05:00","dependencies":[{"issue_id":"cg-pnm.3","depends_on_id":"cg-pnm","type":"parent-child","created_at":"2025-12-30T03:01:53.30186273-05:00","created_by":"daemon"},{"issue_id":"cg-pnm.3","depends_on_id":"cg-pnm.2","type":"blocks","created_at":"2025-12-30T03:02:02.191668498-05:00","created_by":"daemon"}]}
{"id":"cg-y0p","title":"Investigate bd sync not pushing changes to beads-sync branch","description":"## Problem\n\n`bd sync` reports 'No changes to commit' even when local `.beads/issues.jsonl` has changes that aren't in the beads-sync branch worktree.\n\n## Observed Behavior\n\n1. Made a change (added comment to cg-55e)\n2. Ran `bd sync --verbose`\n3. Output showed 'No changes to commit'\n4. But `diff .beads/issues.jsonl .git/beads-worktrees/beads-sync/.beads/issues.jsonl` showed differences\n5. Had to manually copy and push:\n   ```bash\n   cp .beads/issues.jsonl .git/beads-worktrees/beads-sync/.beads/\n   cd .git/beads-worktrees/beads-sync\n   git add .beads/issues.jsonl \u0026\u0026 git commit -m 'sync: ...' \u0026\u0026 git push\n   ```\n\n## Environment\n\n- bd version: (check with `bd --version`)\n- Config: `sync-branch: beads-sync` in .beads/config.yaml\n- Worktree exists at: `.git/beads-worktrees/beads-sync`\n\n## Possible Causes\n\n1. Export hash tracking is out of sync (we saw 'JSONL file hash mismatch' warning)\n2. bd is comparing wrong files or using stale hashes\n3. The worktree copy step in sync is not working\n\n## Workaround\n\nManual sync after beads changes:\n```bash\ncp .beads/issues.jsonl .git/beads-worktrees/beads-sync/.beads/\ncd .git/beads-worktrees/beads-sync\ngit add .beads/ \u0026\u0026 git commit -m 'sync: msg' \u0026\u0026 git push origin beads-sync\n```\n\n## Next Steps\n\n1. Check bd source code for sync logic\n2. Try `bd sync` with different flags\n3. Consider filing upstream issue with beads_viewer repo","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-30T16:37:22.682196889-05:00","created_by":"ubuntu","updated_at":"2025-12-30T18:32:21.507001476-05:00","closed_at":"2025-12-30T18:32:21.507001476-05:00","close_reason":"Root cause identified: gitHasBeadsChanges() checks main repo .beads/ which is gitignored, causing CommitToSyncBranch to never be called. Bug is in beads sync.go lines 396-443. Workaround: manual cp to worktree + git commit. Filed findings in issue comments. Upstream issue should be filed at https://github.com/steveyegge/beads","comments":[{"id":4,"issue_id":"cg-y0p","author":"ubuntu","text":"## Root Cause Found\n\nThe bug is in beads sync.go around line 397.\n\n**Setup:**\n- .beads/.gitignore contains * to ignore all beads data files on code branches (main/feature branches)\n- This is intentional - beads data lives on the beads-sync branch, not code branches\n\n**The Problem:**\n\ngitHasBeadsChanges() runs git status --porcelain .beads/ on the main repo, which returns empty because .beads/ is gitignored there.\n\nSince hasChanges is false, CommitToSyncBranch is never called - but that's the function that:\n1. Copies .beads/issues.jsonl to the worktree\n2. Checks for changes IN THE WORKTREE (not gitignored)\n3. Commits if there are changes\n\n**The Fix:**\nWhen useSyncBranch is true, the code should always call CommitToSyncBranch and let it handle the 'no changes' case internally.\n\n**Affected File:** /data/ai-tools/acfs-setup/tools/beads/cmd/bd/sync.go lines 396-443\n\n**Workaround:** Manual sync (see issue description)","created_at":"2025-12-30T23:30:56Z"}]}
