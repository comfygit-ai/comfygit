# Workflow Sync Testing
# Tests importing and syncing workflows with their dependencies

name: Workflow Sync
description: |
  Tests the workflow sync functionality - adding a workflow file and
  having ComfyGit resolve and install required custom nodes.
  This is a core user journey.
category: workflow
priority: high

requirements:
  comfygit: ">=0.3.0"
  disk_space: "1GB"
  network: true  # Needs to resolve nodes from registry

setup:
  - command: rm -rf /workspace/* /workspace/.* 2>/dev/null || true
    description: Clean workspace
    ignore_errors: true

  - command: cg init /workspace --yes
    description: Initialize workspace
    timeout: 30

  - command: cg create production
    description: Create environment
    timeout: 300

steps:
  # Step 1: List workflows (should be empty initially)
  - action: List workflows in fresh environment
    command: cg -e production workflow list
    expect: |
      Should show no workflows or empty list.
      Environment is fresh, no workflows added yet.

  # Step 2: Create a minimal workflow file with custom node dependency
  - action: Create a test workflow with custom node dependency
    command: |
      mkdir -p /workspace/environments/production/ComfyUI/user/default/workflows && cat > /workspace/environments/production/ComfyUI/user/default/workflows/test_workflow.json << 'EOF'
      {
        "last_node_id": 4,
        "last_link_id": 3,
        "nodes": [
          {
            "id": 1,
            "type": "KSampler",
            "pos": [480, 200],
            "size": {"0": 300, "1": 200}
          },
          {
            "id": 2,
            "type": "EmptyLatentImage",
            "pos": [100, 200]
          },
          {
            "id": 3,
            "type": "CLIPTextEncode",
            "pos": [100, 400]
          },
          {
            "id": 4,
            "type": "ImpactWildcardProcessor",
            "pos": [100, 600]
          }
        ],
        "links": [],
        "groups": [],
        "config": {},
        "extra": {}
      }
      EOF
    expect: Workflow file created in ComfyUI workflows directory

  # Step 3: List workflows - should now show the workflow
  - action: List workflows after adding file
    command: cg -e production workflow list
    expect: |
      Should show test_workflow in the list.
      May show that it has unresolved dependencies.
    on_failure: investigate

  # Step 4: Resolve workflow dependencies
  - action: Resolve workflow dependencies with auto-install
    command: cg -e production workflow resolve test_workflow --install
    expect: |
      Should identify required nodes (impact-pack for ImpactWildcardProcessor).
      Should install the required node(s) automatically.
      Should show what was installed.
    timeout: 180
    on_failure: investigate
    verify:
      - "cg -e production node list"

  # Step 5: Verify workflow is now resolved
  - action: Verify workflow dependencies are resolved
    command: cg -e production workflow list
    expect: |
      Should show test_workflow.
      Should no longer show missing dependencies.

  # Step 6: Check that the node was installed
  - action: Verify Impact Pack node was installed
    command: cg -e production node list
    expect: |
      Should show comfyui-impact-pack or similar.
      Should show version and source.

  # Step 7: Create workflow with only builtin nodes
  - action: Create workflow with only builtin nodes
    command: |
      cat > /workspace/environments/production/ComfyUI/user/default/workflows/builtin_only.json << 'EOF'
      {
        "nodes": [
          {
            "id": 1,
            "type": "KSampler",
            "pos": [100, 100]
          },
          {
            "id": 2,
            "type": "EmptyLatentImage",
            "pos": [100, 200]
          }
        ],
        "links": []
      }
      EOF
    expect: Workflow file created

  # Step 8: Resolve builtin-only workflow
  - action: Resolve workflow with only builtin nodes
    command: cg -e production workflow resolve builtin_only
    expect: |
      Should complete quickly.
      Should not require any additional nodes.
      All nodes are builtin to ComfyUI.
    on_failure: investigate

  # Step 9: Explore workflow edge cases
  - action: Explore workflow handling edge cases
    explore: |
      Test some edge cases:
      1. What happens if you modify the workflow file and re-resolve it?
      2. What if you remove a node that a workflow depends on?
         Try: cg -e production node remove comfyui-impact-pack
         Then: cg -e production workflow list
      3. What about a workflow with a node that can't be resolved?
         Create a workflow with "TotallyFakeNodeThatDoesNotExist" and try to resolve it.
      4. What does --auto flag do vs --install?

      Document findings.

  # Step 10: Test workflow with unresolvable node
  - action: Test workflow with unknown node
    command: |
      cat > /workspace/environments/production/ComfyUI/user/default/workflows/bad_workflow.json << 'EOF'
      {
        "nodes": [
          {
            "id": 1,
            "type": "TotallyFakeNodeThatDoesNotExist",
            "pos": [100, 100]
          }
        ],
        "links": []
      }
      EOF
      cg -e production workflow resolve bad_workflow
    expect: |
      Should handle gracefully.
      Should report that node cannot be resolved.
      Should not crash.
    on_failure: document  # This should fail, document how

cleanup:
  - command: rm -rf /workspace/* 2>/dev/null || true
    ignore_errors: true

success_criteria: |
  - Workflow list shows added workflows
  - Missing nodes are detected correctly
  - Node resolution finds correct packages
  - Dependencies are installed with --install flag
  - Workflow shows resolved after installing nodes
  - Unknown nodes are handled gracefully with clear messages
