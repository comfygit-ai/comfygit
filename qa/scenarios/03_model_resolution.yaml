# Model Resolution Testing
# Tests model index and download functionality

name: Model Resolution
description: |
  Tests the model index and download functionality.
  Covers model indexing, searching, and download management.
category: model
priority: medium

requirements:
  comfygit: ">=0.3.0"
  disk_space: "2GB"
  network: true

setup:
  - command: rm -rf /workspace/* /workspace/.* 2>/dev/null || true
    description: Clean workspace
    ignore_errors: true

  - command: cg init /workspace --yes
    description: Initialize workspace
    timeout: 30

  - command: cg create production
    description: Create environment (needed for model commands)
    timeout: 300

steps:
  # Step 1: Check model index status
  - action: Check model index status
    command: cg model index status
    expect: |
      Should show models directory path.
      Should show index statistics.
      May show no models indexed initially.
    timeout: 30

  # Step 2: List indexed models (likely empty)
  - action: List indexed models
    command: cg model index list
    expect: |
      Should work even with no models indexed.
      May show empty list or message about no models.
    on_failure: investigate

  # Step 3: Sync/scan model index
  - action: Sync model index
    command: cg model index sync
    expect: |
      Should scan the models directory.
      Should update the index.
      May find 0 models if directory is empty.
    timeout: 60

  # Step 4: Search for models (with empty index)
  - action: Search model index
    command: cg model index find sd
    expect: |
      Should search by filename pattern.
      May return no results if no models present.
      Should not crash on empty index.
    on_failure: document

  # Step 5: Check registry status
  - action: Check registry status for nodes
    command: cg registry status
    expect: |
      Should show registry cache status.
      Should show when it was last updated.

  # Step 6: Explore model download (info only, don't download large files)
  - action: Explore model commands
    explore: |
      Explore model management:
      1. What commands are available under 'cg model'?
         Try: cg model --help
      2. How does 'cg model download' work?
         Try: cg model download --help
      3. What about 'cg model add-source'?
         Try: cg model add-source --help
      4. Can you set a models directory?
         Try: cg model index dir --help

      Document the available functionality.

  # Step 7: Create workflow that references a model
  - action: Create workflow with model reference
    command: |
      mkdir -p /workspace/environments/production/ComfyUI/user/default/workflows && cat > /workspace/environments/production/ComfyUI/user/default/workflows/model_workflow.json << 'EOF'
      {
        "nodes": [
          {
            "id": 1,
            "type": "CheckpointLoaderSimple",
            "widgets_values": ["dreamshaper_v8.safetensors"]
          },
          {
            "id": 2,
            "type": "KSampler",
            "pos": [400, 200]
          }
        ],
        "links": []
      }
      EOF
    expect: Workflow file created

  # Step 8: Check workflow status - should detect missing model
  - action: List workflow with model reference
    command: cg -e production workflow list
    expect: |
      Should show model_workflow.
      May indicate model is not available.
    on_failure: investigate
    timeout: 60

  # Step 9: Resolve workflow (won't install model, but should identify it)
  - action: Attempt to resolve workflow with missing model
    command: cg -e production workflow resolve model_workflow
    expect: |
      Should identify the model reference.
      Should indicate the model is not found locally.
      May suggest download options.
    on_failure: document
    timeout: 60

  # Step 10: Explore model resolution edge cases
  - action: Explore model resolution
    explore: |
      Investigate model handling:
      1. What happens when a workflow references a model not in the index?
      2. How are CivitAI vs HuggingFace models handled?
      3. What error message appears for invalid model references?
      4. Does 'cg model add-source' allow adding download URLs?

      Note: Don't actually download large models - just test the resolution logic.

cleanup:
  - command: rm -rf /workspace/* 2>/dev/null || true
    ignore_errors: true

success_criteria: |
  - Model index commands work without errors
  - Model index sync scans directory
  - Model search works (even on empty index)
  - Workflow model detection works
  - Error messages are clear and actionable
  - No crashes on edge cases
