# Basic Workspace Setup and Node Installation
# Tests the fundamental happy path for ComfyGit usage

name: Basic Workspace Setup
description: |
  Tests creating a workspace, adding an environment, installing nodes,
  and verifying the setup is correct. This is the foundational scenario
  that must work for anything else to work.
category: workspace
priority: critical

# Environment requirements
requirements:
  comfygit: ">=0.3.0"
  disk_space: "500MB"

setup:
  - command: rm -rf /workspace/* /workspace/.* 2>/dev/null || true
    description: Clean workspace directory
    ignore_errors: true

steps:
  # Step 1: Initialize workspace
  - action: Initialize a new ComfyGit workspace
    command: cg init /workspace --yes
    expect: |
      Should see confirmation that workspace was created.
      .metadata directory should exist with workspace.json.
    verify:
      - "ls -la /workspace/.metadata/"
      - "cat /workspace/.metadata/workspace.json"

  # Step 2: List environments (should be empty)
  - action: List environments on empty workspace
    command: cg list
    expect: |
      Should show no environments exist yet.
      Should suggest creating one with 'cg create <name>'.

  # Step 3: Create a production environment
  - action: Create a production environment
    command: cg create production
    expect: |
      Environment should be created.
      Should see progress for ComfyUI clone/setup.
      Python venv should be created at environments/production/.venv
    on_failure: investigate
    timeout: 300  # May take time to clone ComfyUI
    verify:
      - "ls -la /workspace/environments/"
      - "cg list"

  # Step 4: Check environment status
  - action: Check production environment status
    command: cg -e production status
    expect: |
      Should show environment details.
      Should show git branch info.
      Should show no uncommitted changes (fresh environment).

  # Step 5: Install a popular custom node
  - action: Install ComfyUI-Manager node
    command: cg -e production node add comfyui-manager
    expect: |
      Should download and install the node.
      Should update pyproject.toml in .cec directory.
    on_failure: investigate
    timeout: 120
    verify:
      - "cg -e production status"
      - "ls /workspace/environments/production/ComfyUI/custom_nodes/"

  # Step 6: Verify node installation in pyproject
  - action: Verify pyproject.toml updated correctly
    command: cat /workspace/environments/production/.cec/pyproject.toml
    expect: |
      Should contain [tool.comfygit.nodes.comfyui-manager] section.
      Should have proper formatting with version, repository, etc.

  # Step 7: Install another node to test multiple nodes
  - action: Install another custom node
    command: cg -e production node add efficiency-nodes-comfyui
    expect: |
      Should install second node.
      Both nodes should coexist.
    timeout: 120
    verify:
      - "cg -e production node list"

  # Step 8: Check overall status
  - action: Final status check
    command: cg -e production status
    expect: |
      Should show uncommitted changes (added nodes).
      Should suggest committing changes.

  # Step 9: Try listing nodes
  - action: List installed nodes
    command: cg -e production node list
    expect: |
      Should show comfyui-manager with version.
      Should show efficiency-nodes-comfyui with version.
      Should show comfygit-manager (pre-installed).
      Should show sources (registry).

  # Step 10: Exploration - look for edge cases
  - action: Explore edge cases
    explore: |
      Try some edge cases:
      1. What happens if you try to add an already-installed node?
         Try: cg -e production node add comfyui-manager
      2. What happens with a non-existent node name?
         Try: cg -e production node add totally-fake-node-12345
      3. Does 'cg registry status' work? What about 'cg registry update'?
      4. Are there any confusing error messages?

      Document anything unexpected or confusing.

cleanup:
  - command: rm -rf /workspace/* 2>/dev/null || true
    description: Clean up test workspace
    ignore_errors: true

success_criteria: |
  - Workspace initializes without errors
  - Environment creates successfully with Python venv
  - Nodes install and appear in status and node list
  - pyproject.toml in .cec directory is properly updated
  - No crashes or unexpected errors
  - Error messages (if any) are clear and actionable
