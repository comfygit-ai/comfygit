# Docker Compose for ComfyGit QA Testing
#
# Runs as non-root 'qa' user for security.
#
# === Quick Start (Direct Host) ===
#   cd qa
#   docker compose up -d
#   docker compose exec qa bash
#   docker compose exec qa claude   # Test Claude auth
#
# === Docker-in-Docker (e.g., ACFS) ===
#   cp .env.example .env
#   # Edit .env with your host paths
#   docker compose up -d
#
# === Running Scenarios ===
#   docker compose exec qa python /qa/scripts/run_scenario.py --native /qa/scenarios/01_basic_workspace_setup.yaml
#
# === Using Local ComfyGit Code ===
#   docker compose exec qa sudo uv pip install --system /comfygit/packages/core /comfygit/packages/cli

services:
  qa:
    build:
      context: ..
      dockerfile: qa/Dockerfile
    image: comfygit-qa:local
    container_name: comfygit-qa-dev

    # Keep container running (entrypoint handles auth setup as qa user with sudo)
    command: ["tail", "-f", "/dev/null"]

    volumes:
      # Claude credentials only (not full .claude dir - QA has its own config)
      - ${CLAUDE_CREDS_PATH:-./_claude-placeholder}:/mnt/claude-credentials.json:ro

      # ComfyGit repo for local development
      - ${COMFYGIT_PATH:-..}:/comfygit:ro

      # QA outputs and live-editable files
      - ${QA_REPORTS_PATH:-./reports}:/reports
      - ${QA_SCENARIOS_PATH:-./scenarios}:/qa/scenarios:ro
      - ${QA_INSTRUCTIONS_PATH:-./agent_instructions}:/qa/agent_instructions:ro

    environment:
      # Terminal colors (passthrough from host)
      - TERM=xterm-256color
      - COLORTERM=truecolor
      # Claude API (alternative to OAuth)
      - ANTHROPIC_API_KEY
      # ComfyGit
      - COMFYGIT_HOME=/workspace
      - QA_SCENARIOS=/qa/scenarios
      - QA_INSTRUCTIONS=/qa/agent_instructions
      - QA_REPORTS=/reports
      - GIT_AUTHOR_NAME=QA Agent
      - GIT_AUTHOR_EMAIL=qa@comfygit.dev
      - GIT_COMMITTER_NAME=QA Agent
      - GIT_COMMITTER_EMAIL=qa@comfygit.dev

    working_dir: /workspace

    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
