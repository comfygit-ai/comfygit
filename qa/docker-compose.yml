# Docker Compose for ComfyGit QA Testing
#
# Runs as non-root 'qa' user for security.
# Supports parallel agents with shared UV cache for fast dependency resolution.
#
# === Quick Start (Single Agent) ===
#   cd qa
#   docker compose up -d
#   docker compose exec qa bash
#   docker compose exec qa claude
#
# === Multi-Agent Parallel Execution ===
#   # Create shared volume (once)
#   docker volume create qa-shared
#
#   # Start multiple agents with unique IDs
#   AGENT_ID=1 docker compose -p qa-1 up -d
#   AGENT_ID=2 docker compose -p qa-2 up -d
#   AGENT_ID=3 docker compose -p qa-3 up -d
#
#   # Run scenarios on specific agents
#   docker compose -p qa-1 exec qa python /qa/scripts/run_scenario.py /qa/scenarios/01_basic_workspace_setup.yaml
#
#   # Cleanup
#   docker compose -p qa-1 down
#   docker compose -p qa-2 down
#
# === Docker-in-Docker (e.g., ACFS) ===
#   cp .env.example .env
#   # Edit .env with HOST paths
#   docker compose up -d
#
# === Local ComfyGit Code ===
#   Entrypoint auto-installs from /comfygit mount if present.
#   To reinstall: docker compose exec qa /qa/install-local.sh

services:
  qa:
    build:
      context: ..
      dockerfile: qa/Dockerfile
    image: comfygit-qa:local
    container_name: comfygit-qa-${AGENT_ID:-dev}

    # Keep container running (entrypoint handles setup)
    command: ["tail", "-f", "/dev/null"]

    volumes:
      # Shared volume for UV cache and per-agent workspaces
      # Enables hardlinks between cache and .venv (same filesystem)
      - qa-shared:/shared

      # Claude credentials (read-only)
      - ${CLAUDE_CREDS_PATH:-./_claude-placeholder}:/mnt/claude-credentials.json:ro

      # ComfyGit repo for local development (auto-installed by entrypoint)
      - ${COMFYGIT_PATH:-..}:/comfygit:ro

      # QA outputs and live-editable files
      - ${QA_REPORTS_PATH:-./reports}:/reports
      - ${QA_SCENARIOS_PATH:-./scenarios}:/qa/scenarios:ro
      - ${QA_INSTRUCTIONS_PATH:-./agent_instructions}:/qa/agent_instructions:ro

    environment:
      # Agent identity (for parallel execution)
      - AGENT_ID=${AGENT_ID:-dev}

      # UV cache on shared volume (enables hardlinks to .venv)
      - UV_CACHE_DIR=/shared/uv_cache

      # Per-agent workspace on shared volume
      - COMFYGIT_HOME=/shared/workspace-${AGENT_ID:-dev}

      # Terminal colors
      - TERM=xterm-256color
      - COLORTERM=truecolor

      # Claude API (alternative to OAuth)
      - ANTHROPIC_API_KEY

      # QA paths
      - QA_SCENARIOS=/qa/scenarios
      - QA_INSTRUCTIONS=/qa/agent_instructions
      - QA_REPORTS=/reports

      # Git identity
      - GIT_AUTHOR_NAME=QA Agent ${AGENT_ID:-dev}
      - GIT_AUTHOR_EMAIL=qa-${AGENT_ID:-dev}@comfygit.dev
      - GIT_COMMITTER_NAME=QA Agent ${AGENT_ID:-dev}
      - GIT_COMMITTER_EMAIL=qa-${AGENT_ID:-dev}@comfygit.dev

    working_dir: /shared/workspace-${AGENT_ID:-dev}

    # ==========================================================================
    # Resource Limits
    # ==========================================================================
    # Each QA agent gets enough resources to run ComfyUI workflows
    # With 3-5 agents at 16GB each, stays within host capacity
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 16G
        reservations:
          cpus: '1'
          memory: 2G
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

    # Shared memory for ML frameworks (PyTorch, etc.)
    shm_size: 4gb

    # Security options for profiling/debugging if needed
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined

    # Logging limits to prevent disk fill
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

volumes:
  qa-shared:
    # External volume persists across project namespaces (qa-1, qa-2, etc.)
    # Create with: docker volume create qa-shared
    external: true
